<ion-header>
  <ion-toolbar>
    <ion-title>Compras</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-segment [(ngModel)]="segmentoActivo">
    <ion-segment-button value="first" content-id="first"><ion-label>Registrar</ion-label></ion-segment-button>
    <ion-segment-button value="fourd" content-id="fourd"><ion-label>Adeudos</ion-label></ion-segment-button>
    <ion-segment-button value="second" content-id="second"><ion-label>Editar/Eliminar</ion-label></ion-segment-button>
    <ion-segment-button value="third" content-id="third"><ion-label>Ver</ion-label></ion-segment-button>
  </ion-segment>

  <ion-segment-view>


<ion-segment-content id="first">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Nueva Compra</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- SelecciÃ³n de Cliente -->
      <ion-item>
        <ion-label>Cliente</ion-label>
        <ion-select [(ngModel)]="clienteSeleccionado" placeholder="Selecciona un cliente" (ionChange)="verificarClienteSeleccionado()">
          <ion-select-option *ngFor="let cliente of clientesDisponibles" [value]="cliente.nombre">{{ cliente.nombre }}</ion-select-option>
          <ion-select-option value="otro">Otro...</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Nombre nuevo cliente -->
      <ion-item *ngIf="clienteSeleccionado === 'otro'">
        <ion-label position="floating">Nombre del nuevo cliente</ion-label>
        <ion-input [(ngModel)]="nuevaCotizacion.cliente"></ion-input>
      </ion-item>

      <!-- Mostrar cliente si no es "otro" -->
      <ion-item *ngIf="clienteSeleccionado !== 'otro'">
        <ion-label position="floating">Cliente</ion-label>
        <ion-input [(ngModel)]="nuevaCotizacion.cliente" [readonly]="true"></ion-input>
      </ion-item>

      <!-- Fecha -->
      <ion-item>
        <ion-label position="floating">Fecha</ion-label>
        <ion-datetime display-format="YYYY-MM-DD" [(ngModel)]="nuevaCotizacion.fecha"></ion-datetime>
      </ion-item>

      <!-- Folio -->
      <ion-item>
        <ion-label position="floating">Folio</ion-label>
        <ion-input [(ngModel)]="nuevaCotizacion.folio" readonly></ion-input>
      </ion-item>

      <!-- Lista de productos -->
      <div style="max-height: 600px; overflow-y: auto;">
        <ng-container *ngFor="let producto of nuevaCotizacion.productos; let i = index">

          <!-- Buscador con sugerencias -->
          <div class="sugerencia-wrapper" style="position: relative;">
            <ion-item>
              <ion-label position="stacked">Producto</ion-label>
              <ion-input
                [(ngModel)]="filtroProductos[i]"
                (ionInput)="filtrarProductos(i)"
                (focus)="mostrarSugerencias[i] = true"
                placeholder="Buscar producto"
                autocomplete="off"
              ></ion-input>
            </ion-item>

            <!-- AAA -->
                       <ion-item>
            <ion-label>Producto {{ i + 1 }}</ion-label>
            <ion-select [(ngModel)]="producto.id" placeholder="Selecciona un producto" (ionChange)="calcularTotal()">
              <ion-select-option *ngFor="let p of productosFiltrados[i]" [value]="p.id">
                {{ p.nombre }} - ${{ p.precio }}
              </ion-select-option>
            </ion-select>
          </ion-item>

            <!-- Lista con scroll para sugerencias -->
            <div
              *ngIf="mostrarSugerencias[i] && productosFiltrados[i]?.length"
              class="sugerencias-dropdown"
            >
              <div
                class="sugerencia-item"
                *ngFor="let producto of productosFiltrados[i]"
                (click)="seleccionarProducto(i, producto)"
              >
                {{ producto.nombre }}
              </div>
            </div>
          </div>

          <!-- Cantidad -->
          <ion-item>
            <ion-label position="floating">Cantidad</ion-label>
            <ion-input
              type="number"
              min="1"
              [(ngModel)]="nuevaCotizacion.productos[i].cantidad"
              (ionChange)="calcularTotal()"
            ></ion-input>
          </ion-item>

        </ng-container>
      </div>

      <!-- BotÃ³n para agregar producto -->
      <ion-button expand="block" (click)="agregarProducto()">+ Agregar otro producto</ion-button>

      <!-- Total -->
      <ion-item lines="none">
        <ion-label><strong>Total:</strong></ion-label>
        <ion-text color="primary">${{ totalCotizacion }}</ion-text>
      </ion-item>

      <!-- BotÃ³n para registrar compra -->
      <ion-button expand="block" color="success" (click)="registrarCotizacion()">Registrar Compra</ion-button>
    </ion-card-content>
  </ion-card>
</ion-segment-content>


    <!-- ABONOS -->
    <ion-segment-content id="fourd">
      <ion-card *ngFor="let compra of comprasConAdeudo">
        <ion-card-header>
          <ion-card-title>{{ compra.cliente }}</ion-card-title>
          <ion-card-subtitle>{{ compra.fecha }} | Folio: {{ compra.folio }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <p><strong>Total:</strong> ${{ compra.total }}</p>
          <p><strong>Pagado:</strong> ${{ compra.pagado }}</p>
          <p>
            <strong>Saldo pendiente:</strong>
            <ion-text [color]="compra.total - compra.pagado <= 0 ? 'success' : 'danger'">
              ${{ compra.total - compra.pagado }}
            </ion-text>
          </p>
          <ion-item *ngIf="compra.total - compra.pagado > 0">
            <ion-label position="floating">Monto a abonar</ion-label>
            <ion-input type="number" [(ngModel)]="compra.montoAbono"></ion-input>
          </ion-item>

          <ion-button expand="block" color="success" (click)="registrarAbono(compra)" *ngIf="compra.total - compra.pagado > 0">
            Registrar Abono
          </ion-button>
          <ion-text color="success" *ngIf="compra.total - compra.pagado <= 0">
            âœ… Compra pagada
          </ion-text>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="comprasConAdeudo.length === 0">
        <ion-card-content class="ion-text-center">
          <ion-text color="success"><strong>No hay abonos pendientes</strong></ion-text>
        </ion-card-content>
      </ion-card>
    </ion-segment-content>

    <!-- EDITAR/ELIMINAR -->
<ion-segment-content id="second">
  <ion-item>
    <ion-label position="floating">Buscar por cliente, fecha o folio</ion-label>
    <ion-input [(ngModel)]="filtroBusqueda" placeholder="Ej. Juan, 2025-07-31 o COT-0004"></ion-input>
  </ion-item>

  <ion-card *ngIf="cotizacionEditando">
    <ion-card-header><ion-card-title>Editar Compra</ion-card-title></ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label position="floating">Cliente</ion-label>
        <ion-input [(ngModel)]="cotizacionEditando.cliente"></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="floating">Fecha</ion-label>
        <ion-datetime display-format="YYYY-MM-DD" [(ngModel)]="cotizacionEditando.fecha"></ion-datetime>
      </ion-item>
      <ion-item>
        <ion-label position="floating">Folio</ion-label>
        <ion-input [(ngModel)]="cotizacionEditando.folio" readonly></ion-input>
      </ion-item>

      <ng-container *ngFor="let prod of cotizacionEditando.productos; let i = index">
        <ion-item>
          <ion-label>Producto {{ i + 1 }}</ion-label>
          <ion-select [(ngModel)]="prod.id">
            <ion-select-option *ngFor="let p of productosDisponibles" [value]="p.id">{{ p.nombre }} - ${{ p.precio }}</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item>
          <ion-label position="floating">Cantidad</ion-label>
          <ion-input type="number" [(ngModel)]="prod.cantidad"></ion-input>
        </ion-item>
      </ng-container>

      <ion-button expand="block" color="primary" (click)="guardarEdicionCotizacion()">Guardar Cambios</ion-button>
      <ion-button expand="block" color="medium" (click)="cancelarEdicion()">Cancelar</ion-button>

      <!-- BotÃ³n para generar PDF desde cotizaciÃ³n en ediciÃ³n -->
      <ion-button expand="block" color="secondary" (click)="descargarPDF(cotizacionEditando.id)">
        Descargar PDF
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card *ngFor="let cotizacion of cotizacionesFiltradas">
    <ion-card-header>
      <ion-card-title>{{ cotizacion.cliente }}</ion-card-title>
      <ion-card-subtitle>{{ cotizacion.fecha }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Folio:</strong> {{ cotizacion.folio }}</p>
      <p><strong>Total:</strong> ${{ cotizacion.total }}</p>
      <ion-button color="warning" (click)="editarCotizacion(cotizacion)">Editar</ion-button>
      <ion-button color="danger" (click)="eliminarCotizacion(cotizacion.id)">Eliminar</ion-button>

      <!-- BotÃ³n para generar PDF desde listado -->
      <ion-button expand="block" color="secondary" (click)="descargarPDF(cotizacion.id)">
        ðŸ“„ Descargar PDF
      </ion-button>
    </ion-card-content>
  </ion-card>
</ion-segment-content>

    <!-- VER -->
<ion-segment-content id="third">
  <ion-card *ngFor="let cotizacion of cotizaciones">
    <ion-card-header>
      <ion-card-title>{{ cotizacion.cliente }}</ion-card-title>
      <ion-card-subtitle>{{ cotizacion.fecha }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Folio:</strong> {{ cotizacion.folio }}</p>
      <p><strong>Total:</strong> ${{ cotizacion.total }}</p>
      <p><strong>Pagado:</strong> ${{ cotizacion.pagado }}</p>
      <p>
        <strong>Estado:</strong>
        <ion-text [color]="cotizacion.estado === 'Pagado' ? 'success' : 'danger'">
          {{ cotizacion.estado }}
        </ion-text>
      </p>
      <p *ngIf="cotizacion.estado !== 'Pagado'">
        <strong>Abono:</strong>
        <ion-text color="danger">${{ cotizacion.adeudo }}</ion-text>
      </p>
      <ul>
        <li *ngFor="let prod of cotizacion.productos">{{ prod.nombre }} - {{ prod.cantidad }} unidades</li>
      </ul>

      <!-- BotÃ³n para generar PDF -->
      <ion-button expand="block" color="secondary" (click)="descargarPDF(cotizacion.id)">
        Descargar PDF
      </ion-button>
    </ion-card-content>
  </ion-card>
</ion-segment-content>

  </ion-segment-view>
</ion-content>
